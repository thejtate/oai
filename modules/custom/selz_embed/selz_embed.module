<?php
/**
 * @file
 * Selz embed store integration
 */

/**
 * Implements hook_ckeditor_plugin().
 */
function selz_embed_ckeditor_plugin() {
  return array(
    'selz_embed' => array(
      // Name of the plugin used to write it.
      'name' => 'selz_embed',
      // Description of the plugin - it would be displayed in the plugins management section of profile settings.
      'desc' => t('Selz'),
      // The full URL to the CKEditor plugins directory, with the trailing slash.
      'path' => drupal_get_path('module', 'selz_embed') . '/plugin/',
      'buttons' => array(
        'selz_embed' => array(
          // Path to an icon relative to the plugins folder.
          'icon' => 'img/icon.png',
          'label' => 'Selz',
        )
      )
    ),
  );
}

/**
 * Implementation of hook_filter_info().
 */
function selz_embed_filter_info() {
  $filters['selz_embed_filter'] = array(
    'title' => t('Selz Embed Filter'),
    'description' => t('Converts Selz content markup generated by CKEditor into embed widget markup.'),
    'process callback' => 'selz_embed_filter_process',
    'weight' => 9,
  );
  return $filters;
}

/**
 * Filter process function.
 */
function selz_embed_filter_process($text, $filter, $format, $langcode, $cache, $cache_id) {

  if(stripos($text, '<em class="site_selz_embed_anchor"') !== FALSE) {
    $output = '';
    preg_match_all('`<em class="site_selz_embed_anchor" data-plugin=".*?>SELZ</em>`is', $text, $matches, PREG_OFFSET_CAPTURE);
    if(!empty($matches[0])) {

      $end_pos = 0;//last widget end position
      foreach ($matches[0] as $match) {

        if(!empty($match[0]) && !empty($match[1])) {
          $embed_string = $match[0];
          $start_pos = $match[1];
          $str_len = strlen($embed_string);
          $output .= substr($text, $end_pos, $start_pos - $end_pos);
          $output .= selz_embed_html(selz_embed_parse_attributes_data($embed_string));

          $end_pos = $start_pos + $str_len;//calculate next end_pos
        }
      }
      $output .= substr($text, $end_pos);
      $text = $output;
    }

  }
  return $text;
}

/**
 * Get widget attributes from string.
 * @param string $tag widget tag
 *
 * @return array
 */
function selz_embed_parse_attributes_data($tag) {
  $attributes = array();

  if (preg_match_all('`data-plugin="(.*?)"`is', $tag, $matches, PREG_SET_ORDER)) {

    if(!empty($matches[0][1])) {
      if($data = (array) json_decode(decode_entities($matches[0][1]))) {
        $attributes = $data;
      }
    }
  }
  return $attributes;
}

/**
 * Default widget settings
 *
 * @return array
 */
function selz_embed_default_args() {

  $defaults = array(
    'title'				=> 'Selz Widget',
    'url'				=> '',//'link'				=> '',
    //'store_link'		=> '',//'store_link'		=> '',
    'type'				=> 'button',
    'interact' 			=> 'modal',
    'position' 			=> 'default',
    'text_color' 		=> '#ffffff',
    'background_color' 	=> '#6d48cc',
    'link_color' 		=> '#6d48cc',
    'chbg_color' 		=> '#6d48cc',
    'chtx_color' 		=> '#ffffff',
    'tab_active'		=> array( 0 => true, 1 => false, 2 => false ),
    'show_logos'        => 'false',
    'intro_text' 		=> '',
    'outro_text' 		=> '',
    'customstylescript'	=> ''
  );

  return $defaults;
}

/**
 * Build widget html from given params.
 *
 * @param array $args
 *
 * @return string
 */
function selz_embed_html($args) {

  foreach ($args as $k => $v) {
    $args[$k] = str_replace(array('true', 'false'), array(TRUE, FALSE), $v);
  }

  $default_args = selz_embed_default_args();
  $args = array_merge($default_args, $args);


  // Remove the # for hexcolor
  foreach (array('link_color', 'text_color', 'background_color', 'chbg_color', 'chbg_color', 'chtx_color') as $color_field_name) {
    $args[$color_field_name] = str_replace( '#', '', $args[$color_field_name] );
  }

  if ('store' == $args['type']) {

    $parseurl = parse_url( $args['url'] );
    $host = explode( ".", $parseurl['host'] );
    $store_domain = $host[0];

    $html = '<script data-selz-cb="'.$args['background_color'].'" data-selz-cbt="'.$args['text_color'].'" data-selz-cl="'.$args['link_color'].'" data-selz-s="'.$store_domain.'" data-selz-chbg="'.$args['chbg_color'].'" data-selz-chtx="'.$args['chtx_color'].'">
			if (typeof _$elz === "undefined") { var _$elz = {}; }
			if (typeof _$elz.s === "undefined") {
				_$elz.s = { e: document.createElement("script") };
				_$elz.s.e.src = "https://selz.com/embed/store/'.$store_domain.'";
				document.body.appendChild(_$elz.s.e);
			}
		</script>
		<noscript><a href="'.$args['url'].'" target="_blank">'. t('Buy on Selz') .'</a><a href="https://selz.com/" target="_blank">'. t('Sell digital downloads on Selz') .'</a></noscript>';

  }
  elseif ('button' == $args['type']) {
    $html = '<script data-selz-t="_selz-btn-'.$args['position'].'" data-selz-a="'.$args['interact'].'" data-selz-ct="'.$args['text_color'].'" data-selz-cb="'.$args['background_color'].'" data-selz-b="'.trim($args['url']).'"'.($args['show_logos'] ? ' data-selz-lg="true"' : '').'  data-selz-chbg="'.$args['chbg_color'].'" data-selz-chtx="'.$args['chtx_color'].'">
			if (typeof _$elz === "undefined") { var _$elz = {}; }
			if (typeof _$elz.b === "undefined") {
				_$elz.b = { e: document.createElement("script") };
				_$elz.b.e.src = "https://selz.com/embed/button";
				document.body.appendChild(_$elz.b.e);
			}
		</script>
		<noscript><a href="'.$args['url'].'" target="_blank">'. t('Buy on Selz') .'</a><a href="https://selz.com/" target="_blank">'. t('Sell digital downloads on Selz') .'</a></noscript>';

  }
  else {
    $html = '<script data-selz-a="'.$args['interact'].'" data-selz-ct="'.$args['text_color'].'" data-selz-cb="'.$args['background_color'].'" data-selz-w="'.trim($args['url']).'"'.($args['show_logos'] ? ' data-selz-lg="true"' : '').' data-selz-chbg="'.$args['chbg_color'].'" data-selz-chtx="'.$args['chtx_color'].'">
			if (typeof _$elz === "undefined") { var _$elz = {}; }
			if (typeof _$elz.w === "undefined") {
				_$elz.w = { e: document.createElement("script") };
				_$elz.w.e.src = "https://selz.com/embed/widget";
				document.body.appendChild(_$elz.w.e);
			}
		</script>
		<noscript><a href="'.$args['url'].'" target="_blank">'. t('Buy on Selz') .'</a><a href="https://selz.com/" target="_blank">'. t('Sell digital downloads on Selz') .'</a></noscript>';
  }

  return $html;
}